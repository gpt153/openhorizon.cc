// Prisma schema for Open Horizon Project Companion
// Multi-tenant SaaS with organization-based tenancy

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // extensions = [pgvector(map: "vector")] // Will enable when we add RAG features
}

// ============================================================================
// TENANCY & USER MANAGEMENT
// ============================================================================

model Organization {
  id               String           @id @default(uuid()) @db.Uuid
  name             String
  slug             String           @unique
  subscriptionTier SubscriptionTier @default(FREE)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  projects           Project[]
  userMemberships    UserOrganizationMembership[]
  generationSessions ProjectGenerationSession[]
  programmes         Programme[]
  brainstormSessions BrainstormSession[]
  seeds              Seed[]
  seedElaborations   SeedElaboration[]
  pipelineProjects   PipelineProject[]
  vendors            Vendor[]
  communications     Communication[]
  expenses           Expense[]

  @@map("organizations")
}

enum SubscriptionTier {
  FREE
  BASIC
  PRO
}

model UserOrganizationMembership {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") // Clerk user ID
  organizationId String   @map("organization_id") @db.Uuid
  role           UserRole
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("user_organization_memberships")
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
  PARTNER
  PARTICIPANT
  GUARDIAN
}

// ============================================================================
// PROJECTS
// ============================================================================

model Project {
  id              String @id @default(uuid()) @db.Uuid
  tenantId        String @map("tenant_id") @db.Uuid
  createdByUserId String @map("created_by_user_id")

  title   String
  tagline String?
  status  ProjectStatus @default(DRAFT)

  // Project DNA (JSON) - defines all characteristics
  projectDna Json @map("project_dna")

  // Generated content from AI
  objectives              Json?
  targetGroupDescription  String? @map("target_group_description") @db.Text
  activityOutline         Json?   @map("activity_outline")
  learningOutcomes        Json?   @map("learning_outcomes")
  inclusionPlanOverview   String? @map("inclusion_plan_overview") @db.Text
  partnerProfile          String? @map("partner_profile") @db.Text
  estimatedBudgetRange    Json?   @map("estimated_budget_range")
  sustainabilityNarrative String? @map("sustainability_narrative") @db.Text
  impactNarrative         String? @map("impact_narrative") @db.Text

  // Formal mode equivalents (application-ready language)
  targetGroupDescriptionFormal  String? @map("target_group_description_formal") @db.Text
  inclusionPlanOverviewFormal   String? @map("inclusion_plan_overview_formal") @db.Text
  partnerProfileFormal          String? @map("partner_profile_formal") @db.Text
  sustainabilityNarrativeFormal String? @map("sustainability_narrative_formal") @db.Text
  impactNarrativeFormal         String? @map("impact_narrative_formal") @db.Text

  // Erasmus+ metadata
  erasmusAction    String @map("erasmus_action")
  durationDays     Int    @map("duration_days")
  participantCount Int    @map("participant_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  generationSessions ProjectGenerationSession[]
  programmes         Programme[]

  @@index([tenantId, status])
  @@index([tenantId, createdByUserId])
  @@map("projects")
}

enum ProjectStatus {
  DRAFT
  CONCEPT
  PLANNING
  APPLICATION_DRAFT
  SUBMITTED
  APPROVED
  IN_PROGRESS
  COMPLETED
}

// ============================================================================
// AI GENERATION TRACKING
// ============================================================================

model ProjectGenerationSession {
  id        String  @id @default(uuid()) @db.Uuid
  tenantId  String  @map("tenant_id") @db.Uuid
  projectId String? @map("project_id") @db.Uuid
  userId    String  @map("user_id")

  sessionData      Json             @map("session_data")
  aiModel          String           @map("ai_model")
  generationStatus GenerationStatus @default(IN_PROGRESS) @map("generation_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([tenantId, userId])
  @@index([projectId])
  @@map("project_generation_sessions")
}

enum GenerationStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================================================
// PROGRAMME BUILDER
// ============================================================================

model Programme {
  id        String @id @default(uuid()) @db.Uuid
  projectId String @map("project_id") @db.Uuid
  tenantId  String @map("tenant_id") @db.Uuid

  version Int             @default(1)
  status  ProgrammeStatus @default(DRAFT)

  generatedFromConcept Json   @map("generated_from_concept")
  aiModel              String @default("gpt-4-turbo-preview") @map("ai_model")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project      Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization Organization   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  days         ProgrammeDay[]

  @@index([projectId])
  @@index([tenantId])
  @@map("programmes")
}

enum ProgrammeStatus {
  DRAFT
  FINAL
  ARCHIVED
}

model ProgrammeDay {
  id          String @id @default(uuid()) @db.Uuid
  programmeId String @map("programme_id") @db.Uuid

  dayNumber Int       @map("day_number")
  date      DateTime? @db.Date
  theme     String?   @db.VarChar(200)

  morningFocus   String? @map("morning_focus") @db.VarChar(500)
  afternoonFocus String? @map("afternoon_focus") @db.VarChar(500)
  eveningFocus   String? @map("evening_focus") @db.VarChar(500)

  // Formal mode equivalents
  morningFocusFormal   String? @map("morning_focus_formal") @db.VarChar(500)
  afternoonFocusFormal String? @map("afternoon_focus_formal") @db.VarChar(500)
  eveningFocusFormal   String? @map("evening_focus_formal") @db.VarChar(500)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  programme Programme          @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  sessions  ProgrammeSession[]

  @@unique([programmeId, dayNumber])
  @@index([programmeId])
  @@map("programme_days")
}

model ProgrammeSession {
  id             String @id @default(uuid()) @db.Uuid
  programmeDayId String @map("programme_day_id") @db.Uuid

  startTime DateTime @map("start_time") @db.Time
  endTime   DateTime @map("end_time") @db.Time

  title        String        @db.VarChar(200)
  description  String?       @db.Text
  activityType ActivityType? @map("activity_type")

  // Formal mode equivalents
  titleFormal       String? @map("title_formal") @db.VarChar(200)
  descriptionFormal String? @map("description_formal") @db.Text

  learningObjectives String[] @map("learning_objectives")
  methodology        String?  @db.VarChar(100)

  materialsNeeded        String[] @map("materials_needed")
  preparationNotes       String?  @map("preparation_notes") @db.Text
  preparationNotesFormal String?  @map("preparation_notes_formal") @db.Text
  spaceRequirements      String?  @map("space_requirements") @db.VarChar(200)
  groupSize              String?  @map("group_size") @db.VarChar(50)

  accessibilityNotes String? @map("accessibility_notes") @db.Text
  languageLevel      String? @map("language_level") @db.VarChar(20)

  orderIndex Int     @map("order_index")
  isOptional Boolean @default(false) @map("is_optional")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  day ProgrammeDay @relation(fields: [programmeDayId], references: [id], onDelete: Cascade)

  @@index([programmeDayId])
  @@index([startTime])
  @@map("programme_sessions")
}

enum ActivityType {
  ICEBREAKER
  WORKSHOP
  REFLECTION
  ENERGIZER
  FREE_TIME
  MEAL
  PRESENTATION
  GROUP_WORK
  OUTDOOR
  CULTURAL
  INTERCULTURAL
  CREATIVE
  SPORTS
  DISCUSSION
}

// ============================================================================
// BRAINSTORMING PLAYGROUND
// ============================================================================

model BrainstormSession {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid
  userId   String @map("user_id")

  prompt         String @db.Text
  creativityTemp Float  @default(0.9) @map("creativity_temperature")
  seedCount      Int    @default(10) @map("seed_count")

  generationStatus GenerationStatus @default(IN_PROGRESS) @map("generation_status")
  aiModel          String           @default("gpt-4-turbo-preview") @map("ai_model")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  seeds        Seed[]

  @@index([tenantId, userId])
  @@map("brainstorm_sessions")
}

model Seed {
  id        String @id @default(uuid()) @db.Uuid
  sessionId String @map("session_id") @db.Uuid
  tenantId  String @map("tenant_id") @db.Uuid
  userId    String @map("user_id")

  // Working mode (original - informal, authentic language)
  title              String @db.VarChar(200)
  description        String @db.Text
  approvalLikelihood Float  @default(0.5) @map("approval_likelihood") // 0.0-1.0

  // Formal mode (application-ready Erasmus+ language)
  titleFormal              String? @map("title_formal") @db.VarChar(200)
  descriptionFormal        String? @map("description_formal") @db.Text
  approvalLikelihoodFormal Float?  @map("approval_likelihood_formal")

  isSaved     Boolean @default(false) @map("is_saved")
  isDismissed Boolean @default(false) @map("is_dismissed")

  // Elaboration tracking
  elaborationCount Int   @default(0) @map("elaboration_count")
  currentVersion   Json? @map("current_version") // Latest elaborated version

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  session      BrainstormSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  organization Organization      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  elaborations SeedElaboration[]

  @@index([tenantId, userId, isSaved])
  @@index([sessionId])
  @@map("seeds")
}

model SeedElaboration {
  id       String @id @default(uuid()) @db.Uuid
  seedId   String @map("seed_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  conversationHistory Json @map("conversation_history") // Array of messages
  currentSeedState    Json @map("current_seed_state") // Current elaborated seed

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  seed         Seed         @relation(fields: [seedId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([seedId]) // One elaboration session per seed
  @@index([tenantId])
  @@map("seed_elaborations")
}

// ============================================================================
// PIPELINE MODELS
// ============================================================================

model PipelineProject {
  id              String @id @default(uuid()) @db.Uuid
  tenantId        String @map("tenant_id") @db.Uuid
  createdByUserId String @map("created_by_user_id")

  name             String
  type             ProjectType
  status           PipelineProjectStatus @default(PLANNING)
  description      String?               @db.Text
  startDate        DateTime              @map("start_date")
  endDate          DateTime              @map("end_date")
  budgetTotal      Decimal               @map("budget_total") @db.Decimal(12, 2)
  budgetSpent      Decimal               @default(0) @map("budget_spent") @db.Decimal(12, 2)
  participantCount Int                   @map("participant_count")
  location         String
  originCountry    String?               @map("origin_country")
  hostCountry      String?               @map("host_country")

  // Erasmus+ specific
  erasmusGrantCalculated Decimal? @map("erasmus_grant_calculated") @db.Decimal(12, 2)
  erasmusGrantActual     Decimal? @map("erasmus_grant_actual") @db.Decimal(12, 2)
  estimatedCosts         Decimal? @map("estimated_costs") @db.Decimal(12, 2)
  profitMargin           Decimal? @map("profit_margin") @db.Decimal(5, 2)

  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phases          PipelinePhase[]
  communications  Communication[]
  aiConversations AIConversation[]
  expenses        Expense[]
  budgetAlerts    BudgetAlert[]

  @@index([tenantId, status])
  @@index([tenantId, createdByUserId])
  @@map("pipeline_projects")
}

model PipelinePhase {
  id        String @id @default(uuid()) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  name            String
  type            PhaseType
  status          PhaseStatus @default(NOT_STARTED)
  startDate       DateTime    @map("start_date")
  endDate         DateTime    @map("end_date")
  budgetAllocated Decimal     @map("budget_allocated") @db.Decimal(12, 2)
  budgetSpent     Decimal     @default(0) @map("budget_spent") @db.Decimal(12, 2)
  order           Int

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project         PipelineProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  communications  Communication[]
  quotes          Quote[]
  aiConversations AIConversation[]
  expenses        Expense[]

  @@index([projectId])
  @@index([status])
  @@index([type])
  @@map("pipeline_phases")
}

model Vendor {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  name               String
  type               VendorType
  email              String?
  phone              String?
  website            String?
  location           String?
  rating             Decimal?   @db.Decimal(3, 2)
  responseRate       Decimal?   @map("response_rate") @db.Decimal(4, 2)
  successfulBookings Int        @default(0) @map("successful_bookings")
  totalContacts      Int        @default(0) @map("total_contacts")
  notes              String?    @db.Text
  metadata           Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization   Organization    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  communications Communication[]
  quotes         Quote[]

  @@index([tenantId, type])
  @@index([rating])
  @@map("vendors")
}

model Expense {
  id        String @id @default(uuid()) @db.Uuid
  tenantId  String @map("tenant_id") @db.Uuid
  projectId String @map("project_id") @db.Uuid
  phaseId   String @map("phase_id") @db.Uuid

  amount      Decimal         @db.Decimal(12, 2)
  currency    String          @default("EUR")
  category    ExpenseCategory
  description String          @db.Text
  date        DateTime
  receiptUrl  String?         @map("receipt_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project      PipelineProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase        PipelinePhase   @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([tenantId, projectId])
  @@index([phaseId])
  @@index([category])
  @@index([date])
  @@map("expenses")
}

model BudgetAlert {
  id        String @id @default(uuid()) @db.Uuid
  projectId String @map("project_id") @db.Uuid

  threshold       Int       @db.Integer // Percentage threshold (e.g., 90, 100)
  emailRecipients String[] // Array of email addresses
  enabled         Boolean   @default(true)
  lastTriggeredAt DateTime? @map("last_triggered_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project PipelineProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([enabled])
  @@map("budget_alerts")
}

model Communication {
  id        String  @id @default(uuid()) @db.Uuid
  tenantId  String  @map("tenant_id") @db.Uuid
  projectId String  @map("project_id") @db.Uuid
  phaseId   String? @map("phase_id") @db.Uuid
  vendorId  String? @map("vendor_id") @db.Uuid

  type               CommunicationType
  direction          CommunicationDirection
  subject            String?
  body               String                 @db.Text
  status             CommunicationStatus
  sentAt             DateTime?              @map("sent_at")
  responseReceivedAt DateTime?              @map("response_received_at")

  // SendGrid tracking fields
  sendgridMessageId String?   @map("sendgrid_message_id")
  deliveredAt       DateTime? @map("delivered_at")
  openedAt          DateTime? @map("opened_at")
  openCount         Int       @default(0) @map("open_count")
  clickCount        Int       @default(0) @map("click_count")
  bouncedAt         DateTime? @map("bounced_at")
  bounceReason      String?   @map("bounce_reason")
  trackingMetadata  Json?     @map("tracking_metadata")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project      PipelineProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase        PipelinePhase?  @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  vendor       Vendor?         @relation(fields: [vendorId], references: [id])

  @@index([tenantId, projectId])
  @@index([phaseId])
  @@index([vendorId])
  @@index([status])
  @@index([sendgridMessageId])
  @@map("communications")
}

model Quote {
  id       String @id @default(uuid()) @db.Uuid
  phaseId  String @map("phase_id") @db.Uuid
  vendorId String @map("vendor_id") @db.Uuid

  amount     Decimal     @db.Decimal(12, 2)
  currency   String      @default("EUR")
  validUntil DateTime?   @map("valid_until")
  status     QuoteStatus @default(PENDING)
  details    Json?
  notes      String?     @db.Text

  receivedAt DateTime @default(now()) @map("received_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  phase  PipelinePhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  vendor Vendor        @relation(fields: [vendorId], references: [id])

  @@index([phaseId])
  @@index([vendorId])
  @@index([status])
  @@map("quotes")
}

model AIConversation {
  id        String  @id @default(uuid()) @db.Uuid
  projectId String  @map("project_id") @db.Uuid
  phaseId   String? @map("phase_id") @db.Uuid
  agentType String  @map("agent_type") // 'accommodation', 'activities', 'emergency'
  messages  Json // Array of {role, content, timestamp}

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project PipelineProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase   PipelinePhase?  @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([phaseId])
  @@map("ai_conversations")
}

// Enums
enum ProjectType {
  STUDENT_EXCHANGE
  TRAINING
  CONFERENCE
  CUSTOM
}

enum PipelineProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PhaseType {
  ACCOMMODATION
  TRAVEL
  FOOD
  ACTIVITIES
  INSURANCE
  EMERGENCY
  CUSTOM
}

enum PhaseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  BLOCKED
}

enum VendorType {
  HOTEL
  HOSTEL
  GUESTHOUSE
  RESTAURANT
  CATERING
  ACTIVITY_PROVIDER
  TRANSPORT
  INSURANCE
  OTHER
}

enum CommunicationType {
  EMAIL
  PHONE
  OTHER
}

enum CommunicationDirection {
  OUTBOUND
  INBOUND
}

enum CommunicationStatus {
  DRAFT
  SENT
  DELIVERED
  OPENED
  RESPONDED
  FAILED
  BOUNCED
}

enum QuoteStatus {
  PENDING
  RECEIVED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ExpenseCategory {
  ACCOMMODATION
  TRAVEL
  FOOD
  ACTIVITIES
  INSURANCE
  EMERGENCY
  OTHER
}
