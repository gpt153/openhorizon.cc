// Prisma schema for Open Horizon Project Companion
// Multi-tenant SaaS with organization-based tenancy

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // extensions = [pgvector(map: "vector")] // Will enable when we add RAG features
}

// ============================================================================
// TENANCY & USER MANAGEMENT
// ============================================================================

model Organization {
  id               String   @id @default(uuid()) @db.Uuid
  name             String
  slug             String   @unique
  subscriptionTier SubscriptionTier @default(FREE)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  projects         Project[]
  userMemberships  UserOrganizationMembership[]
  generationSessions ProjectGenerationSession[]
  programmes       Programme[]

  @@map("organizations")
}

enum SubscriptionTier {
  FREE
  BASIC
  PRO
}

model UserOrganizationMembership {
  id             String       @id @default(uuid()) @db.Uuid
  userId         String       @map("user_id") // Clerk user ID
  organizationId String       @map("organization_id") @db.Uuid
  role           UserRole
  createdAt      DateTime     @default(now()) @map("created_at")

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("user_organization_memberships")
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
  PARTNER
  PARTICIPANT
  GUARDIAN
}

// ============================================================================
// PROJECTS
// ============================================================================

model Project {
  id                      String        @id @default(uuid()) @db.Uuid
  tenantId                String        @map("tenant_id") @db.Uuid
  createdByUserId         String        @map("created_by_user_id")

  title                   String
  tagline                 String?
  status                  ProjectStatus @default(DRAFT)

  // Project DNA (JSON) - defines all characteristics
  projectDna              Json          @map("project_dna")

  // Generated content from AI
  objectives              Json?
  targetGroupDescription  String?       @map("target_group_description") @db.Text
  activityOutline         Json?         @map("activity_outline")
  learningOutcomes        Json?         @map("learning_outcomes")
  inclusionPlanOverview   String?       @map("inclusion_plan_overview") @db.Text
  partnerProfile          String?       @map("partner_profile") @db.Text
  estimatedBudgetRange    Json?         @map("estimated_budget_range")
  sustainabilityNarrative String?       @map("sustainability_narrative") @db.Text
  impactNarrative         String?       @map("impact_narrative") @db.Text

  // Erasmus+ metadata
  erasmusAction           String        @map("erasmus_action")
  durationDays            Int           @map("duration_days")
  participantCount        Int           @map("participant_count")

  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")

  // Relations
  organization            Organization  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  generationSessions      ProjectGenerationSession[]
  programmes              Programme[]

  @@index([tenantId, status])
  @@index([tenantId, createdByUserId])
  @@map("projects")
}

enum ProjectStatus {
  DRAFT
  CONCEPT
  PLANNING
  APPLICATION_DRAFT
  SUBMITTED
  APPROVED
  IN_PROGRESS
  COMPLETED
}

// ============================================================================
// AI GENERATION TRACKING
// ============================================================================

model ProjectGenerationSession {
  id                String              @id @default(uuid()) @db.Uuid
  tenantId          String              @map("tenant_id") @db.Uuid
  projectId         String?             @map("project_id") @db.Uuid
  userId            String              @map("user_id")

  sessionData       Json                @map("session_data")
  aiModel           String              @map("ai_model")
  generationStatus  GenerationStatus    @map("generation_status") @default(IN_PROGRESS)

  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  organization      Organization        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([tenantId, userId])
  @@index([projectId])
  @@map("project_generation_sessions")
}

enum GenerationStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================================================
// PROGRAMME BUILDER
// ============================================================================

model Programme {
  id                    String          @id @default(uuid()) @db.Uuid
  projectId             String          @map("project_id") @db.Uuid
  tenantId              String          @map("tenant_id") @db.Uuid

  version               Int             @default(1)
  status                ProgrammeStatus @default(DRAFT)

  generatedFromConcept  Json            @map("generated_from_concept")
  aiModel               String          @default("gpt-4-turbo-preview") @map("ai_model")

  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  // Relations
  project               Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization          Organization    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  days                  ProgrammeDay[]

  @@index([projectId])
  @@index([tenantId])
  @@map("programmes")
}

enum ProgrammeStatus {
  DRAFT
  FINAL
  ARCHIVED
}

model ProgrammeDay {
  id              String            @id @default(uuid()) @db.Uuid
  programmeId     String            @map("programme_id") @db.Uuid

  dayNumber       Int               @map("day_number")
  date            DateTime?         @db.Date
  theme           String?           @db.VarChar(200)

  morningFocus    String?           @map("morning_focus") @db.VarChar(500)
  afternoonFocus  String?           @map("afternoon_focus") @db.VarChar(500)
  eveningFocus    String?           @map("evening_focus") @db.VarChar(500)

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  programme       Programme         @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  sessions        ProgrammeSession[]

  @@unique([programmeId, dayNumber])
  @@index([programmeId])
  @@map("programme_days")
}

model ProgrammeSession {
  id                  String        @id @default(uuid()) @db.Uuid
  programmeDayId      String        @map("programme_day_id") @db.Uuid

  startTime           DateTime      @map("start_time") @db.Time
  endTime             DateTime      @map("end_time") @db.Time

  title               String        @db.VarChar(200)
  description         String?       @db.Text
  activityType        ActivityType? @map("activity_type")

  learningObjectives  String[]      @map("learning_objectives")
  methodology         String?       @db.VarChar(100)

  materialsNeeded     String[]      @map("materials_needed")
  preparationNotes    String?       @map("preparation_notes") @db.Text
  spaceRequirements   String?       @map("space_requirements") @db.VarChar(200)
  groupSize           String?       @map("group_size") @db.VarChar(50)

  accessibilityNotes  String?       @map("accessibility_notes") @db.Text
  languageLevel       String?       @map("language_level") @db.VarChar(20)

  orderIndex          Int           @map("order_index")
  isOptional          Boolean       @default(false) @map("is_optional")

  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  day                 ProgrammeDay  @relation(fields: [programmeDayId], references: [id], onDelete: Cascade)

  @@index([programmeDayId])
  @@index([startTime])
  @@map("programme_sessions")
}

enum ActivityType {
  ICEBREAKER
  WORKSHOP
  REFLECTION
  ENERGIZER
  FREE_TIME
  MEAL
  PRESENTATION
  GROUP_WORK
  OUTDOOR
  CULTURAL
  INTERCULTURAL
  CREATIVE
  SPORTS
  DISCUSSION
}
